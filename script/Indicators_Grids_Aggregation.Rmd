---
title: "Indicators_Grids_Aggregation"
author: "Bowen He"
date: "3/30/2021"
output: html_document
---

```{r indicators-grids-aggregation-setup, include=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidycensus)
library(sf)
library(dplyr)
library(tidyverse)
library(gt)
library(raster)
library(sp)
library(rgdal)
library(inlmisc)
library(stars)

if (!exists("census_tract_grid")) {
 census_tract_grid <- read_sf(dsn = "/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/census_tract_grid.shp", layer = "census_tract_grid")
}

```

## Demographic Diversity (#demographic)

Her we import the indicators ingredients ACS data associated with demographic diversity dimension, manipulated data to the census tract grid scale and calculated.

### Population (#pop)
```{r pop, include = FALSE, message=FALSE, warning=FALSE}

# NLCD dasymetric spatial aggregation
pop_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/population-2018.tif")
pop_2018_nlcd <- pop_2018_nlcd * 900
pop_2018_nlcd <-  aggregate(pop_2018_nlcd, fact = 5, fun = sum)
pop_2018_nlcd <- pop_2018_nlcd/(150*150)
#-----------------------------------------------------------------------------------------------------------------------------------------
# Parcel dasymetric spatial aggregation
#----------------------create 30m resolution grid template-------------------------------
census_tract_grid_30 <- st_as_stars(population_2010) 
census_tract_grid_30$`population-2010`[is.na(census_tract_grid_30$`population-2010`)] <- 0
census_tract_grid_30 <- st_as_sf(census_tract_grid_30, as_points = FALSE, merge = FALSE) %>%
  mutate(grid_area = st_area(.), grid_id = 1:nrow(.)) %>%
  dplyr::select(-'population-2010')

st_write(census_tract_grid_30, dsn = "/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data", layer = "census_tract_grid_30",
         driver = "ESRI Shapefile", append = FALSE)

#----------------------create 150m resolution grid template-------------------------------
census_tract_grid_150 <- st_as_stars(pop_2018_nlcd) 
census_tract_grid_150$population.2018[is.na(census_tract_grid_150$population.2018)] <- 0
census_tract_grid_150 <- st_as_sf(census_tract_grid_150, as_points = FALSE, merge = FALSE) %>%
  mutate(grid_area = st_area(.), grid_id = 1:nrow(.)) %>%
  dplyr::select(-'population.2018')

st_write(census_tract_grid_150, dsn = "/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data", layer = "census_tract_grid_150",
         driver = "ESRI Shapefile", append = FALSE)

 census_tract_grid_150 <- read_sf(dsn = "/data/martrec/2018_parcel_dasymetric/census_tract_grid_150.shp", layer = "census_tract_grid_150")
#-------------------------------150m resolution--------------------------------------------------------------------------------
#pop_2018_parcel <- st_read("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_parcel_dasymetric/pop/2018_pb_dasy_population.shp") %>%
  #st_transform(st_crs(pop_2018_nlcd))

 pop_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/pop/2018_pb_dasy_population.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

 
pop_2018_parcel_grid_150 <- pop_2018_parcel %>% 
  mutate(bld_area = st_area(.))

pop_2018_parcel_grid_150 <-  st_intersection(st_buffer(pop_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

pop_2018_parcel_grid_150$tot_pop[is.na(pop_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(pop_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
#st_write(pop_2018_parcel_grid_150, dsn = "/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data", layer = "pop_2018_parcel_grid_150",
#driver = "ESRI Shapefile", append = FALSE)

st_write(pop_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/pop", layer = "pop_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```


### Male population (#male-pop)
```{r male-pop, include = FALSE, message=FALSE, warning=FALSE}

# NLCD dasymetric spatial aggregation
male_pop_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/male-population-2018.tif")
male_pop_2018_nlcd <- male_pop_2018_nlcd * 900
male_pop_2018_nlcd <- aggregate(male_pop_2018_nlcd, fact = 5, fun = sum)
male_pop_2018_nlcd <- male_pop_2018_nlcd/(150*150)
#--------------------------------------------------------------------------------------------------------------------------------------------
# Parcel dasymetric spatial aggregation
# male_pop_2018_parcel <- st_read("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_parcel_dasymetric/male-pop/2018_pb_dasy_male_pop.shp")
male_pop_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/male-pop/2018_pb_dasy_male_pop.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

male_pop_2018_parcel_grid_150 <- male_pop_2018_parcel %>% 
  mutate(bld_area = st_area(.))

male_pop_2018_parcel_grid_150 <-  st_intersection(st_buffer(male_pop_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

male_pop_2018_parcel_grid_150$tot_pop[is.na(male_pop_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(male_pop_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(male_pop_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/male-pop", layer = "male_pop_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```


### Female population (#female-pop)
```{r male-pop, include = FALSE, message=FALSE, warning=FALSE}

# NLCD dasymetric spatial aggregation
female_pop_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/female-population-2018.tif")
female_pop_2018_nlcd <- female_pop_2018_nlcd * 900
female_pop_2018_nlcd <- aggregate(female_pop_2018_nlcd, fact = 5, fun = sum)
female_pop_2018_nlcd <- female_pop_2018_nlcd/(150*150)
#--------------------------------------------------------------------------------------------------------------------------------------------
# Parcel dasymetric spatial aggregation
# male_pop_2018_parcel <- st_read("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_parcel_dasymetric/male-pop/2018_pb_dasy_male_pop.shp")
female_pop_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/female-pop/2018_pb_dasy_female_pop.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

female_pop_2018_parcel_grid_150 <- female_pop_2018_parcel %>% 
  mutate(bld_area = st_area(.))

female_pop_2018_parcel_grid_150 <-  st_intersection(st_buffer(female_pop_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

female_pop_2018_parcel_grid_150$tot_pop[is.na(female_pop_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(female_pop_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(female_pop_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/female-pop", layer = "female_pop_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Disable population (#disable-pop)
```{r disable-pop, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
disable_pop_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/disable-population-2018.tif")
disable_pop_2018_nlcd <- disable_pop_2018_nlcd * 900
disable_pop_2018_nlcd <- aggregate(disable_pop_2018_nlcd, fact = 5, fun = sum)
disable_pop_2018_nlcd <- disable_pop_2018_nlcd/(150*150)
#-----------------------------------------150-m resolution--------------------------------------------------
disable_pop_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/disable-pop/2018_pb_dasy_disable_pop.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

disable_pop_2018_parcel_grid_150 <- disable_pop_2018_parcel %>% 
  mutate(bld_area = st_area(.))

disable_pop_2018_parcel_grid_150 <-  st_intersection(st_buffer(disable_pop_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

disable_pop_2018_parcel_grid_150$tot_pop[is.na(disable_pop_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(disable_pop_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(disable_pop_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/disable-pop", layer = "disable_pop_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### African American (#black)

```{r black, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
black_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/african-american-2018.tif")
black_2018_nlcd <- black_2018_nlcd * 900
black_2018_nlcd <- aggregate(black_2018_nlcd, fact = 5, fun = sum)
black_2018_nlcd <- black_2018_nlcd/(150*150)
#-------------------------150-m resolution------------------------------
black_pop_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/africa-america/2018_pb_dasy_black_pop.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

black_pop_2018_parcel_grid_150 <- black_pop_2018_parcel %>% 
  mutate(bld_area = st_area(.))

black_pop_2018_parcel_grid_150 <-  st_intersection(st_buffer(black_pop_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

black_pop_2018_parcel_grid_150$tot_pop[is.na(black_pop_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(black_pop_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(black_pop_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/africa-america", layer = "black_pop_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```


### Hispanic Latino population (#latino)
```{r black, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
latino_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/hispanic-2018.tif")
latino_2018_nlcd <- latino_2018_nlcd * 900
latino_2018_nlcd <- aggregate(latino_2018_nlcd, fact = 5, fun = sum)
latino_2018_nlcd <- latino_2018_nlcd/(150*150)
#-------------------------150-m resolution------------------------------
hispanic_pop_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/hispanic/2018_pb_dasy_hispanic_pop.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

hispanic_pop_2018_parcel_grid_150 <- hispanic_pop_2018_parcel %>% 
  mutate(bld_area = st_area(.))

hispanic_pop_2018_parcel_grid_150 <-  st_intersection(st_buffer(hispanic_pop_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

hispanic_pop_2018_parcel_grid_150$tot_pop[is.na(hispanic_pop_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(hispanic_pop_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(hispanic_pop_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/hispanic", layer = "hispanic_pop_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### White population (#white)
```{r white, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
white_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/white-only-2018.tif")
white_2018_nlcd <- white_2018_nlcd * 900
white_2018_nlcd <- aggregate(white_2018_nlcd, fact = 5, fun = sum)
white_2018_nlcd <- white_2018_nlcd/(150*150)
#-------------------------150-m resolution------------------------------
white_pop_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/white/2018_pb_dasy_white_pop.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

white_pop_2018_parcel_grid_150 <- white_pop_2018_parcel %>% 
  mutate(bld_area = st_area(.))

white_pop_2018_parcel_grid_150 <-  st_intersection(st_buffer(white_pop_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

white_pop_2018_parcel_grid_150$tot_pop[is.na(white_pop_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(white_pop_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(white_pop_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/white", layer = "white_pop_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Poverty population (#poverty)
```{r poverty, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
poverty_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/poverty-2018.tif")
poverty_2018_nlcd <- poverty_2018_nlcd * 900
poverty_2018_nlcd <- aggregate(poverty_2018_nlcd, fact = 5, fun = sum)
poverty_2018_nlcd <- poverty_2018_nlcd/(150*150)
#-------------------------150-m resolution------------------------------
poverty_pop_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/poverty/2018_pb_dasy_poverty_pop.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

poverty_pop_2018_parcel_grid_150 <- poverty_pop_2018_parcel %>% 
  mutate(bld_area = st_area(.))

poverty_pop_2018_parcel_grid_150 <-  st_intersection(st_buffer(poverty_pop_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

poverty_pop_2018_parcel_grid_150$tot_pop[is.na(poverty_pop_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(poverty_pop_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(poverty_pop_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/poverty", layer = "poverty_pop_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### limited education attainment (#limit-education-attain)
```{r limit-education-attain, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
limit_education_attain_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/limit-education-attain-2018.tif")
limit_education_attain_2018_nlcd <- limit_education_attain_2018_nlcd * 900
limit_education_attain_2018_nlcd <- aggregate(limit_education_attain_2018_nlcd, fact = 5, fun = sum)
limit_education_attain_2018_nlcd <- limit_education_attain_2018_nlcd/(150*150)
#-------------------------150-m resolution------------------------------
limit_education_attain_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/limit-education-attain/2018_pb_dasy_limit_education_attain_pop.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

limit_education_attain_2018_parcel_grid_150 <- limit_education_attain_2018_parcel %>% 
  mutate(bld_area = st_area(.))

limit_education_attain_2018_parcel_grid_150 <-  st_intersection(st_buffer(limit_education_attain_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

limit_education_attain_2018_parcel_grid_150$tot_pop[is.na(limit_education_attain_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(limit_education_attain_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(limit_education_attain_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/limit-education-attain", layer = "limit_education_attain_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Total family with owned children (#family-owned-child)

```{r family-owned-child, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
family_own_children_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/family-own-children-2018.tif")
family_own_children_2018_nlcd <- family_own_children_2018_nlcd * 900
family_own_children_2018_nlcd <- aggregate(family_own_children_2018_nlcd, fact = 5, fun = sum)
family_own_children_2018_nlcd <- family_own_children_2018_nlcd/(150*150)
#-------------------------150-m resolution------------------------------
family_own_children_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/family-own-children/2018_pb_dasy_family_own_children.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

family_own_children_2018_parcel_grid_150 <- family_own_children_2018_parcel %>% 
  mutate(bld_area = st_area(.))

family_own_children_2018_parcel_grid_150 <-  st_intersection(st_buffer(family_own_children_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

family_own_children_2018_parcel_grid_150$tot_pop[is.na(family_own_children_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(family_own_children_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(family_own_children_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/family-own-children", layer = "family_own_children_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Total household (#household)

```{r household, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
household_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/total-household-2018.tif")
household_2018_nlcd <- household_2018_nlcd * 900
household_2018_nlcd <- aggregate(household_2018_nlcd, fact = 5, fun = sum)
household_2018_nlcd <- household_2018_nlcd/(150*150)

#-------------------------150-m resolution------------------------------
household_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/total-household/2018_pb_dasy_total_household.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

household_2018_parcel_grid_150 <- household_2018_parcel %>% 
  mutate(bld_area = st_area(.))

household_2018_parcel_grid_150 <-  st_intersection(st_buffer(household_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

household_2018_parcel_grid_150$tot_pop[is.na(household_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(household_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(household_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/total-household", layer = "total_household_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```


### Total occupied housing units (#occupied-housing)
```{r occupied-housing, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
occupied_housing_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/total-housing-units-2018.tif")
occupied_housing_2018_nlcd <- occupied_housing_2018_nlcd * 900
occupied_housing_2018_nlcd <- aggregate(occupied_housing_2018_nlcd, fact = 5, fun = sum)
occupied_housing_2018_nlcd <- occupied_housing_2018_nlcd/(150*150)

#-------------------------150-m resolution------------------------------
housing_units_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/total-housing-units/2018_pb_dasy_total_housing_units.shp") %>%
  st_transform(st_crs(pop_2018_nlcd))

housing_units_2018_parcel_grid_150 <- housing_units_2018_parcel %>% 
  mutate(bld_area = st_area(.))

housing_units_2018_parcel_grid_150 <-  st_intersection(st_buffer(housing_units_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

housing_units_2018_parcel_grid_150$tot_pop[is.na(housing_units_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(housing_units_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(housing_units_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/total-housing-units", layer = "total_housing_units_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Single parent family (#single-parent-family)

```{r single-parent-family, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
single_parent_family_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/single-parent-family-2018.tif")
single_parent_family_2018_nlcd <- single_parent_family_2018_nlcd * 900
single_parent_family_2018_nlcd <- aggregate(single_parent_family_2018_nlcd, fact = 5, fun = sum)
single_parent_family_2018_nlcd <- single_parent_family_2018_nlcd/(150*150)

#-------------------------150-m resolution------------------------------
single_parent_family_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/single-parent-family/2018_pb_dasy_single_parent_family.shp") %>% st_transform(st_crs(pop_2018_nlcd))

single_parent_family_2018_parcel_grid_150 <- single_parent_family_2018_parcel %>% 
  mutate(bld_area = st_area(.))

single_parent_family_2018_parcel_grid_150 <-  st_intersection(st_buffer(single_parent_family_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

single_parent_family_2018_parcel_grid_150$tot_pop[is.na(single_parent_family_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(single_parent_family_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(single_parent_family_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/single-parent-family", layer = "single_parent_family_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### single person household (#single-person-household)
```{r single-person-household, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
single_person_household_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/single-person-household-2018.tif")
single_person_household_2018_nlcd <- single_person_household_2018_nlcd * 900
single_person_household_2018_nlcd <- aggregate(single_person_household_2018_nlcd, fact = 5, fun = sum)
single_person_household_2018_nlcd <- single_person_household_2018_nlcd/(150*150)

#-------------------------150-m resolution------------------------------
single_person_household_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/single-person-household/2018_pb_dasy_single_person_household.shp") %>% st_transform(st_crs(pop_2018_nlcd))

single_person_household_2018_parcel_grid_150 <- single_person_household_2018_parcel %>% 
  mutate(bld_area = st_area(.))

single_person_household_2018_parcel_grid_150 <-  st_intersection(st_buffer(single_person_household_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

single_person_household_2018_parcel_grid_150$tot_pop[is.na(single_person_household_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(single_person_household_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(single_person_household_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/single-person-household", layer = "single_person_household_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Household with seniors (#senior-household)
```{r senior-household, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
senior_household_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/household-senior-2018.tif")
senior_household_2018_nlcd <- senior_household_2018_nlcd * 900
senior_household_2018_nlcd <- aggregate(senior_household_2018_nlcd, fact = 5, fun = sum)
senior_household_2018_nlcd <- senior_household_2018_nlcd/(150*150)
#-------------------------150-m resolution------------------------------
senior_household_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/household-senior/2018_pb_dasy_household_senior.shp") %>% st_transform(st_crs(pop_2018_nlcd))

senior_household_2018_parcel_grid_150 <- senior_household_2018_parcel %>% 
  mutate(bld_area = st_area(.))

senior_household_2018_parcel_grid_150 <-  st_intersection(st_buffer(senior_household_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

senior_household_2018_parcel_grid_150$tot_pop[is.na(senior_household_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(senior_household_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(senior_household_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/household-senior", layer = "senior_household_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Multi-family housing (#multifamily-house)
```{r multifamily-house, include=FALSE, message=FALSE, warning=FALSE}
# NLCD dasymetric spatial aggregation
multifamily_house_2018_nlcd <- raster("/Users/hebowen/Desktop/MarTREC_project/Data/2018_Data/2018_NLCD_summary/multi-family-housing-2018.tif")
multifamily_house_2018_nlcd <- multifamily_house_2018_nlcd * 900
multifamily_house_2018_nlcd <- aggregate(multifamily_house_2018_nlcd, fact = 5, fun = sum)
multifamily_house_2018_nlcd <- multifamily_house_2018_nlcd/(150*150)

#-------------------------150-m resolution------------------------------
multifamily_house_2018_parcel <- st_read("/data/martrec/2018_parcel_dasymetric/multi-family-housing/2018_pb_dasy_multi_family_housing.shp") %>% st_transform(st_crs(pop_2018_nlcd))

multifamily_house_2018_parcel_grid_150 <- multifamily_house_2018_parcel %>% 
  mutate(bld_area = st_area(.))

multifamily_house_2018_parcel_grid_150 <-  st_intersection(st_buffer(multifamily_house_2018_parcel_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = dsy__LA * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

multifamily_house_2018_parcel_grid_150$tot_pop[is.na(multifamily_house_2018_parcel_grid_150$tot_pop)] <- 0

plot(st_sf(multifamily_house_2018_parcel_grid_150 %>% dplyr::select(-'grid_id', -'grid_area')))
st_write(multifamily_house_2018_parcel_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/multi-family-housing", layer = "multifamily_house_2018_parcel_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Fire Station (#fire-station)
```{r fire-station,  include = FALSE, message = FALSE, warning = FALSE}
template <- pop_2018_nlcd
values(template) = 0

fire_station <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Emergency/Fire_Stations.shp') %>%
    st_transform(st_crs(template)) %>% dplyr::select('ID')

fire_station_raster <- rasterize(fire_station %>%st_buffer(1000), template, field = 'ID', fun='count')

fun <- function(x) { 
  x / (150*150) 
}

fire_station_raster <- fire_station_raster %>% calc(fun)
plot(fire_station_raster)

writeRaster(fire_station_raster,'/Users/hebowen/Desktop/fire_station.tif')

#-------------------------150m resolution----------------------------------
fire_station <- st_read('/data/martrec/2018_parcel_dasymetric/fire_station/Fire_Stations.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('ID') %>% mutate(count = 1)

fire_station_grid_150 <- fire_station %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

fire_station_grid_150 <-  st_intersection(st_buffer(fire_station_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')


fire_station_grid_150$tot_pop[is.na(fire_station_grid_150$tot_pop)] <- 0
st_write(fire_station_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/fire_station", layer = "fire_station_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Grocery Stores (#grocery)
```{r grocery, include=FALSE, message=FALSE, warning=FALSE}
grocery_stores <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Grocery/Stores.shp') %>% 
  st_transform(st_crs(template)) %>% dplyr::select('osm_id')

grocery_stores_raster <- rasterize(grocery_stores %>% st_buffer(1000), template, field = 'osm_id', fun='count')

grocery_stores_raster <- grocery_stores_raster %>% calc(fun)

plot(grocery_stores_raster)
writeRaster(grocery_stores_raster,'/Users/hebowen/Desktop/points_interests_raster/grocery_stores.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
fire_station <- st_read('/data/martrec/2018_parcel_dasymetric/fire_station/Fire_Stations.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('ID') %>% mutate(count = 1)

fire_station_grid_150 <- fire_station %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

fire_station_grid_150 <-  st_intersection(st_buffer(fire_station_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')


fire_station_grid_150$tot_pop[is.na(fire_station_grid_150$tot_pop)] <- 0
st_write(fire_station_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/fire_station", layer = "fire_station_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Super Market (#supermarket)
```{r supermarket, include=FALSE, message=FALSE, warning=FALSE}
supermarket <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Grocery/supermarket.shp') %>% 
 st_transform(st_crs(template)) %>% dplyr::select('osm_id')

supermarket_raster <- rasterize(supermarket %>% st_buffer(1000), template, field = 'osm_id', fun='count')
supermarket_raster <- supermarket_raster %>% calc(fun)
plot(supermarket_raster)
writeRaster(supermarket_raster,'/Users/hebowen/Desktop/points_interests_raster/supermarket.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
supermarket <- st_read('/data/martrec/2018_parcel_dasymetric/supermarket/Supermarket.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

supermarket_grid_150 <- supermarket %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

supermarket_grid_150 <-  st_intersection(st_buffer(supermarket_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

supermarket_grid_150$tot_pop[is.na(supermarket_grid_150$tot_pop)] <- 0
st_write(supermarket_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/supermarket", layer = "supermarket_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Emergency Rooms (#emergency)
```{r emergency, include=FALSE, message=FALSE, warning=FALSE}
emergency <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Healthcare/Emergency Rooms.shp') %>% 
  st_transform(st_crs(template)) %>% dplyr::select('osm_id')

emergency_raster <- rasterize(emergency %>% st_buffer(1000), template, field = 'osm_id', fun='count')
emergency_raster <- emergency_raster %>% calc(fun)
plot(emergency_raster)
writeRaster(emergency_raster,'/Users/hebowen/Desktop/points_interests_raster/emergency.tif', overwrite = TRUE)
#-------------------------150m resolution----------------------------------
emergency <- st_read('/data/martrec/2018_parcel_dasymetric/emergency_rooms/Emergency Rooms.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

emergency_grid_150 <- emergency %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

emergency_grid_150 <-  st_intersection(st_buffer(emergency_grid_150,0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

emergency_grid_150$tot_pop[is.na(emergency_grid_150$tot_pop)] <- 0
st_write(emergency_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/emergency_rooms", layer = "emergency_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Healthcare (#healthcare)
```{r healthcare, include=FALSE, message=FALSE, warning=FALSE}
healthcare <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Healthcare/Healthcare.shp') %>% 
 st_transform(st_crs(template)) %>% dplyr::select('osm_id')

healthcare_raster <- rasterize(healthcare %>% st_buffer(1000), template, field = 'osm_id', fun='count')
healthcare_raster <- healthcare_raster %>% calc(fun)
plot(healthcare_raster)
writeRaster(healthcare_raster,'/Users/hebowen/Desktop/points_interests_raster/healthcare.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
healthcare <- st_read('/data/martrec/2018_parcel_dasymetric/healthcare/Healthcare.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

healthcare_grid_150 <- healthcare %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

healthcare_grid_150 <-  st_intersection(st_buffer(healthcare_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

healthcare_grid_150$tot_pop[is.na(healthcare_grid_150$tot_pop)] <- 0
st_write(healthcare_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/healthcare", layer = "healthcare_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Hospitals (#hospital)
```{r hospital, include=FALSE, message=FALSE, warning=FALSE}
hospital <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Healthcare/Hospitals.shp') %>% 
  st_transform(st_crs(template)) %>% dplyr::select('ID')

hospital_raster <- rasterize(hospital %>% st_buffer(1000), template, field = 'ID', fun='count')
hospital_raster <- hospital_raster %>% calc(fun)
plot(hospital_raster)
writeRaster(hospital_raster,'/Users/hebowen/Desktop/points_interests_raster/hospital.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
hospital <- st_read('/data/martrec/2018_parcel_dasymetric/hospitals/Hospitals.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('ID') %>% mutate(count = 1)

hospital_grid_150 <- hospital %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

hospital_grid_150 <-  st_intersection(st_buffer(hospital_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

hospital_grid_150$tot_pop[is.na(hospital_grid_150$tot_pop)] <- 0
st_write(hospital_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/hospitals", layer = "hospital_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Denominations (#denominations)
```{r denominations, include=FALSE, message=FALSE, warning=FALSE}
denomination <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Religious/Denominations.shp') %>% 
   st_transform(st_crs(template)) %>% dplyr::select('osm_id')

denomination_raster <- rasterize(denomination %>% st_buffer(1000), template, field = 'osm_id', fun='count')
denomination_raster <- denomination_raster %>% calc(fun)
plot(denomination_raster)
writeRaster(denomination_raster,'/Users/hebowen/Desktop/points_interests_raster/denomination.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
denomination <- st_read('/data/martrec/2018_parcel_dasymetric/denominations/Denominations.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

denomination_grid_150 <- denomination %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

denomination_grid_150 <-  st_intersection(st_buffer(denomination_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

denomination_grid_150$tot_pop[is.na(denomination_grid_150$tot_pop)] <- 0
st_write(denomination_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/denominations", layer = "denomination_grid_150", driver = "ESRI Shapefile", append = FALSE)
```


### Places Worship (#Worship)
```{r worship, include=FALSE, message=FALSE, warning=FALSE}
worship <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Religious/Places_of_Worship.shp') %>% 
   st_transform(st_crs(template)) %>% dplyr::select('osm_id')

worship_raster <- rasterize(worship %>% st_buffer(1000), template, field = 'osm_id', fun='count')
worship_raster <- worship_raster %>% calc(fun)
plot(worship_raster)
writeRaster(worship_raster,'/Users/hebowen/Desktop/points_interests_raster/worship.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
worship <- st_read('/data/martrec/2018_parcel_dasymetric/places_worship/Places_of_Worship.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

worship_grid_150 <- worship %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

worship_grid_150 <-  st_intersection(st_buffer(worship_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

worship_grid_150$tot_pop[is.na(worship_grid_150$tot_pop)] <- 0
st_write(worship_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/places_worship", layer = "worship_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### Religion (#religion)
```{r religion, include=FALSE, message=FALSE, warning=FALSE}
religion <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Religious/Religion.shp') %>% 
  st_transform(st_crs(template)) %>% dplyr::select('osm_id')

religion_raster <- rasterize(religion %>% st_buffer(1000), template, field = 'osm_id', fun = 'count')
religion_raster <- religion_raster %>% calc(fun)
plot(religion_raster)
writeRaster(religion_raster,'/Users/hebowen/Desktop/points_interests_raster/religion.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
religion <- st_read('/data/martrec/2018_parcel_dasymetric/religion/Religion.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

religion_grid_150 <- religion %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

religion_grid_150 <-  st_intersection(st_buffer(religion_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

religion_grid_150$tot_pop[is.na(religion_grid_150$tot_pop)] <- 0
st_write(religion_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/religion", layer = "religion_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### College (#college)
```{r college, include=FALSE, message=FALSE, warning=FALSE}
college <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Schools/College.shp') %>% 
  st_transform(st_crs(template)) %>% dplyr::select('osm_id')

college_raster <- rasterize(college %>% st_buffer(1000), template, field = 'osm_id', fun = 'count')
college_raster <- college_raster %>% calc(fun)
plot(college_raster)
writeRaster(college_raster,'/Users/hebowen/Desktop/points_interests_raster/college.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
college <- st_read('/data/martrec/2018_parcel_dasymetric/college/College.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

college_grid_150 <- college %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

college_grid_150 <-  st_intersection(st_buffer(college_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

college_grid_150$tot_pop[is.na(college_grid_150$tot_pop)] <- 0
st_write(college_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/college", layer = "college_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### kindergarten (#kindergarten)
```{r kindergarten, include=FALSE, message=FALSE, warning=FALSE}
kindergarten <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Schools/kindergarten.shp') %>% 
  st_transform(st_crs(template)) %>% dplyr::select('osm_id')

kindergarten_raster <- rasterize(kindergarten %>% st_buffer(1000), template, field = 'osm_id', fun = 'count')
kindergarten_raster <- kindergarten_raster %>% calc(fun)
plot(kindergarten_raster)
writeRaster(kindergarten_raster,'/Users/hebowen/Desktop/points_interests_raster/kindergarten.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
kindergarten <- st_read('/data/martrec/2018_parcel_dasymetric/kindergarten/Kindergarten.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

kindergarten_grid_150 <- kindergarten %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

kindergarten_grid_150 <- st_intersection(st_buffer(kindergarten_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

kindergarten_grid_150$tot_pop[is.na(kindergarten_grid_150$tot_pop)] <- 0
st_write(kindergarten_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/kindergarten", layer = "kindergarten_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### libraries (#libraries)
```{r libraries, include=FALSE, message=FALSE, warning=FALSE}
libraries <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Schools/Libraries.shp') %>% 
  st_transform(st_crs(template)) %>% dplyr::select('osm_id')

libraries_raster <- rasterize(libraries %>% st_buffer(1000), template, field = 'osm_id', fun = 'count')
libraries_raster <- libraries_raster %>% calc(fun)
plot(libraries_raster)
writeRaster(libraries_raster,'/Users/hebowen/Desktop/points_interests_raster/libraries.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
libraries <- st_read('/data/martrec/2018_parcel_dasymetric/libraries/Libraries.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

libraries_grid_150 <- libraries %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

libraries_grid_150 <- st_intersection(st_buffer(libraries_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

libraries_grid_150$tot_pop[is.na(libraries_grid_150$tot_pop)] <- 0
st_write(libraries_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/libraries", layer = "libraries_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### private school (#private-schools)
```{r public, include=FALSE, message=FALSE, warning=FALSE}
private <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Schools/private_schools.shp') %>% 
  st_transform(st_crs(template)) %>% dplyr::select('osm_id')

private_raster <- rasterize(private %>% st_buffer(1000), template, field = 'osm_id', fun = 'count')
private_raster <- private_raster %>% calc(fun)
plot(private_raster)
writeRaster(private_raster,'/Users/hebowen/Desktop/points_interests_raster/private.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
private_school <- st_read('/data/martrec/2018_parcel_dasymetric/private_school/private_schools.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

private_school_grid_150 <- private_school %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

private_school_grid_150 <- st_intersection(st_buffer(private_school_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

private_school_grid_150$tot_pop[is.na(private_school_grid_150$tot_pop)] <- 0
st_write(private_school_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/private_school", layer = "private_school_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### public school (#public-schools)
```{r public, include=FALSE, message=FALSE, warning=FALSE}
public <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Schools/Nashville_Public.shp') %>% 
   st_transform(st_crs(template)) %>% dplyr::select('X1')

public_raster <- rasterize(public %>% st_buffer(1000), template, field = 'X1', fun = 'count')
public_raster <- public_raster %>% calc(fun)
plot(public_raster)
writeRaster(public_raster,'/Users/hebowen/Desktop/points_interests_raster/public.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
public_school <- st_read('/data/martrec/2018_parcel_dasymetric/public_school/Nashville_Public.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('X1') %>% mutate(count = 1)

public_school_grid_150 <- public_school %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

public_school_grid_150 <- st_intersection(st_buffer(public_school_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

public_school_grid_150$tot_pop[is.na(public_school_grid_150$tot_pop)] <- 0
st_write(public_school_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/public_school", layer = "public_school_grid_150", driver = "ESRI Shapefile", append = FALSE)
```


### school (#school)
```{r school, include=FALSE, message=FALSE, warning=FALSE}
school <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Schools/School.shp') %>% 
  st_transform(st_crs(template)) %>% dplyr::select('osm_id')

school_raster <- rasterize(school %>% st_buffer(1000), template, field = 'osm_id', fun = 'count')
school_raster <- school_raster %>% calc(fun)
plot(school_raster)
writeRaster(school_raster,'/Users/hebowen/Desktop/points_interests_raster/school.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
school <- st_read('/data/martrec/2018_parcel_dasymetric/k-12_school/School.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

school_grid_150 <- school %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

school_grid_150 <- st_intersection(st_buffer(school_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

school_grid_150$tot_pop[is.na(school_grid_150$tot_pop)] <- 0
st_write(school_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/k-12_school", layer = "k-12_school_grid_150", driver = "ESRI Shapefile", append = FALSE)
```

### University (#university)
```{r university, include=FALSE, message=FALSE, warning=FALSE}
university <- st_read('/Users/hebowen/Desktop/MarTREC_project/Data/Davidson_points_interests/Schools/University.shp') %>% 
  st_transform(st_crs(template)) %>% dplyr::select('osm_id')

university_raster <- rasterize(university %>% st_buffer(1000), template, field = 'osm_id', fun = 'count')
university_raster <- university_raster %>% calc(fun)
plot(university_raster)
writeRaster(university_raster,'/Users/hebowen/Desktop/points_interests_raster/university.tif', overwrite = TRUE)

#-------------------------150m resolution----------------------------------
university <- st_read('/data/martrec/2018_parcel_dasymetric/university/University.shp') %>%
    st_transform(st_crs(pop_2018_nlcd)) %>% dplyr::select('osm_id') %>% mutate(count = 1)

university_grid_150 <- university %>% st_buffer(1000) %>%
  mutate(bld_area = st_area(.))

university_grid_150 <- st_intersection(st_buffer(university_grid_150, 0), st_buffer(census_tract_grid_150, 0)) %>% # raw intersection
  mutate(in_area = st_area(.)) %>% # area of cell
  # calculate a proportion of births equal to proportion of area
  mutate(dsy_LA_proportion = count * in_area / bld_area) %>% 
  group_by(grid_id) %>% # group by id of grid cell
  summarise(tot_pop = sum(dsy_LA_proportion)) %>%
  st_drop_geometry() %>%
  full_join(census_tract_grid_150, by = 'grid_id')

university_grid_150$tot_pop[is.na(university_grid_150$tot_pop)] <- 0
st_write(university_grid_150, dsn = "/data/martrec/2018_parcel_dasymetric/university", layer = "university_grid_150", driver = "ESRI Shapefile", append = FALSE)
```


















